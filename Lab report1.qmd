---
title: "Lab Report 1"
author: ""
execute: 
  echo: false
  eval: true
number-sections: true
format:
  html:
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| warning: false
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidymodels)
library(sjPlot)
library(performance)
library(kableExtra)
library(gt)
library(tidyr)
library(ggplot2)
library(moderndive)
library(sjPlot)
library(tidymodels)
library(broom)
library(performance)
library(faraway)
library(palmerpenguins)
```

# Introduction {#sec-intro}

Obesity rates have been rising all over the world over the past decades. It has been found that obesity is linked and can impact cardiovascular health and cause other diseases. This paper investigates how the prevelance of obesity has changed over the years (2013-2016) in Scotland and whether gender, age group or other lifestyle choices affect this.

Our two questions of interest are:

-   Has the prevalence of obesity in Scotland changed over the given years of the Scottish Health Survey?

-   Are there any differences in obesity by age, gender, socio-economic status or lifestyle factors?

# Exploratory Analysis {#sec-EA}

We first look at the disparity in proportions of obesity by sex

```{r}
#| echo: false

df <- read.csv("DAProject3.csv")

df$Sex <- as.factor(df$Sex)
df$AgeGroup <- as.factor(df$AgeGroup)
df$Veg <- as.factor(df$Veg)
df$Fruit <- as.factor(df$Fruit)
df$Obese <- as.factor(df$Obese)
df$Employment <- as.factor(df$Employment)

```

```{r}
ggplot(df, aes(x = Sex, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity by Sex")

ggplot(df, aes(x = Year, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity Over Time", y = "Proportion")

ggplot(df, aes(x = AgeGroup, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity by Age Group")

ggplot(df, aes(x = Employment, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity by Employment Status") +
  guides(x = guide_axis(angle = 35))

ggplot(df, aes(x = Veg, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity by Vegetable Intake") 

ggplot(df, aes(x = Fruit, fill = Obese)) + 
  geom_bar(position = "fill") + 
  labs(title = "Obesity by Fruit Intake") 

```

```{r}
#| echo: false
#| label: fig-1
#| fig-cap: barchart of proportion of individuals of each sex are obese

ggplot(df, aes(x = Obese, group = Sex)) +
    geom_bar(aes(y = after_stat(prop), fill = Sex), 
             stat = "count", position = "dodge") +
    labs(x = "Obesity Status", y = "Proportion", fill = "Sex")+
  ggtitle("Obesity Rate by Sex")
```

From @fig-1 it appears that women are more likely to be obese by men. However we can see that this difference is very small and may not be significant.

*It seems like women are slightly more likely to be obese and slightly less likely to not be obese, than men, but whether this changes over the years is what needs to be investigated.*

```{r}
#| echo: false
#| label: fig-2
#| fig-cap: bar plot of obesity over the years

ggplot(data = df,
       aes(x = Year)) +
  geom_bar(aes(y = after_stat(prop), 
             stat = "count"), position = "dodge") +
  labs(x = "Year", 
       y = "Proportion", 
       title = "Obesity Rates over the Years") +
  facet_wrap(df$Obese)
```

From @fig-2 we can see that obesity rates are fairly consistant across the years. his plot there doesn't appear to be much of a change in Obesity over the years, but we should further investigate this.

```{r}
ggplot(data = df,
       aes(x = Obese, y = Year))+
  geom_boxplot()+
  labs(x = "Obese", 
       y = "Year", 
       title = "Obesity Rates over the Years")
```

```{r}
#| echo: false
#| label: fig-3
#| fig-cap: bar plot of obesity over the years

ggplot(data = df,
       aes(x = Year, group = Obese))+
  geom_bar(aes(y = after_stat(prop), fill = Obese, 
             stat = "count"), position = "dodge")+
  labs(x = "Year",
       y = "Proportion", 
       title = "Obesity Rates over the Years", 
       fill = "Obesity Status")+
  facet_wrap(df$Fruit)

ggplot(data = df,
       aes(x = Year, group = Obese))+
  geom_bar(aes(y = after_stat(prop), fill = Obese, 
             stat = "count"), position = "dodge")+
  labs(x = "Year", 
       y = "Proportion", 
       title = "Obesity Rates over the Years", 
       fill = "Obesity Status")+
  facet_wrap(df$Veg)


ggplot(data = df,
       aes(x = Year, group = Obese))+
  geom_bar(aes(y = after_stat(prop), fill = Obese, 
             stat = "count"), position = "dodge")+
  labs(x = "Year", 
       y = "Proportion", 
       title = "Obesity Rates over the Years", 
       fill = "Obesity Status")+
  facet_wrap(df$FV)

```


```{r}
#| echo: false
df <- df %>%
  mutate(Employment_Clean = ifelse(Employment == "Retired", "Retired",
                            ifelse(Employment %in% c("In employment, self-employed or on gov't training", "In full-time education"), "Employed", "Unemployed")))

df$Employment_Clean <- as.factor(df$Employment_Clean)

table(df$Employment_Clean)
```



# Formal Analysis {#sec-FA}

We fit a logistic regression model $$
Obese \sim Bernoulli(p_i)
$$ Where $p_i$ is the probability of being obese

$$
logit(p_i)= \alpha + \beta_{\text{male}}\cdot\mathbb{I}_{\text{male}} + \beta_{\text{year}}\cdot\text{year} + \beta_{\text{fv}}\cdot\text{fv} + \beta_{\text{age}}\cdot\text{age} + \beta_{employment}\cdot\text{employment}
$$ 

where

-   $\alpha$ is the intercept,

-   $\beta_\text{male}$ is the coefficient for sex,

-   $\beta_\text{year}$ is the coefficient for year,

-   $\beta_\text{fv}$ is the coefficient for whether an individual consumes the daily intake of either fruit or vegetables or both,

-   $\beta_\text{year}$ is the coefficient for age,

-   $\beta_\text{year}$ is the coefficient for employment status

-   $\mathbb{I}_{\text{sex}}(x)$ is an indicator function such that


$$
\mathbb{I}_{\mbox{male}}(x) =
\begin{cases}
1 & \mbox{If gender of } x \mbox{ is male}, \\
0 & \mbox{If gender of } x \mbox{ is female}.
\end{cases}
$$

```{r}
#| label: tbl-sum
#| tbl-cap: Summary Table
model <- glm(Obese ~ Sex + Year + FV + AgeGroup + Employment, data = df, family = binomial)
model %>% broom::tidy()%>% gt()
```

As predicted from our plots. Obesity rate hasn't changed over the years, so should be remved from the model. However, it seems that the log-odds of Obesity decreases by 0.112 (find new value now changed) if they are male.

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "Sex",
           axis.title = c("Sex", 
                          "Prob. of being obese"),
           title = " ")
```

```{r}
#| echo: false
#| eval: false
plot_model(model, 
           type = "pred", 
           title = "", 
           terms="Year", 
           axis.title = c("year", "Prob. of obesity"))
```

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "AgeGroup",
           axis.title = c("Age Group", 
                          "Prob. of being obese"),
           title = " ")
```

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "Employment",
           axis.title = c("Employment", 
                          "Prob. of being obese"),
           title = " ")
```

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "Fruit",
           labs(x = "Fruit", 
                y = "Prob. of being obese"),
           title = " ")
```

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "Veg",
           axis.title = c("Veg", 
                          "Prob. of being obese"),
           title = " ")
```

```{r}
#| echo: false
#| eval: false
plot_model(model,
           type = "pred",
           terms = "FV",
           axis.title = c("Fruit and Veg", 
                          "Prob. of being obese"),
           title = " ")
```

```{r}
library(performance)
check_model(model, panel = TRUE)
```

Binned residuals indicates fit inadequate

shockingly cllinearity betweeen fruit veg and fv is only moderate... probs should just include either FV or Fruit and Veg- maybe check AICs
