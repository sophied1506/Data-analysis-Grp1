---
title: "Has Scottish Obesity Prevalence Changed over the Years and do Different Factors Effect this"
author: "Jo Scott-Stephen, Eleanor Mills and Sophie Brown"
execute: 
  echo: false
  eval: true
number-sections: true
format:
  pdf:
    embed-resources: true
    margin-top: 0.7in
    margin-left: 0.7in
    margin-right: 0.7in
    margin-bottom: 0.7in
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| warning: false
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidymodels)
library(sjPlot)
library(performance)
library(kableExtra)
library(gt)
library(tidyverse)
library(gt)
library(MASS)
library(patchwork)
library(moderndive)

```

```{r}
df<-read.csv("DAProject3.csv")
df$Sex<-as.factor(df$Sex)
df$AgeGroup<-as.factor(df$AgeGroup)
df$Veg<-as.factor(df$Veg)
df$Fruit<-as.factor(df$Fruit)
df$Obese<-as.factor(df$Obese)
df$Employment<-as.factor(df$Employment)

df$Employment_Clean<-as.factor(ifelse(df$Employment=="In full-time education"|df$Employment=="In paid employment, self-employed or on gov't training", "Employed/Full-Time Training or Education",ifelse(df$Employment=="Retired", "Retired", "Unemployed/Other")))

df$FV<-as.factor(ifelse(df$Fruit=="Yes"|df$Veg=="Yes", "Yes", "No"))

df$AgeCategory <- as.factor(ifelse(df$AgeGroup %in% c("16-24", "25-34"), "Young",
ifelse(df$AgeGroup %in% c("35-44", "45-54", "55-64"), "Middle-aged",
"Old")))
df$AgeCategory <- relevel(df$AgeCategory, ref = "Young")
```

# Introduction {#sec-intro}

Obesity rates have been observed to be increasing in many developed countries. However it has been linked to numerous health issues, specifically cardiovascular issues, diabetes and cancer. With data supplied by the Scottish Health Survey, we will be examining the trends in obesity of the Scottish population in the years 2013-2016, to see if Scotland is following that trend.

Furthermore, we will investigate whether any specific socio-economic characteristics and lifestyle factors indicate a higher probability of obesity, to see, more generally, if there is truly a correlation between the way we live and our health.

First we will undergo exploratory data analysis in @sec-EA before conducting our formal analysis in @sec-FA and eventually reaching a conclusion and a discussion in @sec-con.

# Exploratory Analysis {#sec-EA}

```{r}
#| label: fig-obesityyear
#| fig-cap: Proportion of Obesity by Year
#| out.width: "50%"
proportionsyear <- df |>
  group_by(Year, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Year) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsyear, aes(x = factor(Year), y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity by Year",
       x = "Year",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal() 

```

@fig-obesityyear displays the proportion of Obesity by the each year the questionnaire has been taken. There appears to be very little if any difference in the change of obesity levels over the years.

```{r}
library(patchwork)

#| label: fig-ages
#| fig-cap: proportion of Obesity by Age Categories

##graph 1
proportionsage <- df |>
  group_by(AgeGroup, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(AgeGroup) |>
  mutate(Proportion = Count/sum(Count))
  

p1 <- ggplot(proportionsage, aes(x = AgeGroup, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity by Age",
       x = "Age",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()+
  guides(x= guide_axis(angle = 90)) 

##graph 2

proportionsagec <- df |>
  group_by(AgeCategory, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(AgeCategory) |>
  mutate(Proportion = Count/sum(Count))

p2 <- ggplot(proportionsagec, aes(x = AgeCategory, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(
       x = "Age",
       y = "Proportion",
       fill = "Obesity") +
  guides(x= guide_axis(angle = 90)) +
  theme_minimal()
```

```{r}
#| label: fig-ages
#| fig-cap: Obesity Proportions against Age Groups and Age Categories
#| out.width: "70%"

p1+p2
```

We look at @fig-ages to see if there is a significant relationship between obesity and age, i.e. can the age of a person change their likelihood of being obese. The bar plot does indicate an increase in obesity as age increases however it then drops in the last category (75+). The difference in ages is made clearer in the right hand plot where the age catgeories have been refined, and we see that young people are least likely to be obese, middle aged are much more likely to be obese and elderly are the most likely to be obese.

@fig-gender is a barplot being used to see if there is a difference in obesity dependent on the gender of a person. The plot shows there is actually a slight difference in gender and obesity levels. There is a larger proportion of women who are obese suggesting if gender is female they are slightly more likely to be obese than men.

```{r}
#| label: fig-gender
#| fig-cap: Proportion of Obesity by Gender
#| out.width: "50%"
#| fig-pos: "H"

proportionsgender <- df |>
  group_by(Sex, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Sex) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsgender, aes(x = Sex, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity by Sex",
       x = "Sex",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal() 
```

@fig-social refers to the Obesity rates of those participating in the survey and their socio-economic status. This has been refined into three categories, 'employed/full time education', 'retired', 'unemployed/other'. We can see that the least amount of obesity occurs in the employed/full time education category, while the category with highest obesity rates is the unemployed/other category which is interesting when compared to the age graphs previously as we might have expected retired to have the highest rates as the older age catgories seemed to have higher obesity rates.

```{r}
#| label: fig-social
#| fig-cap: Proportion of Obesity by Employment Type
#| out.width: "50%"
#| fig-pos: "H"

library(stringr)
library(scales)

proportionssocial <- df |>
  group_by(Employment_Clean, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Employment_Clean) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionssocial, aes(x = Employment_Clean, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity by Employment Type",
       x = "Employment Type",
       y = "Proportion",
       fill = "Obesity") +
   scale_x_discrete(labels = label_wrap(10))+
  theme_minimal()
```

@fig-FV displays a barplot of Obesity rates vs if surveyed people ate the correct amount of fruit and vegetables in a day (lifestyle factors). We might have expected this to show there is a significant impact on obesity rates if people ate their '5 a day' however there seems to be no difference in obesity depending on a persons fruit and veg intake.

```{r}
#| warning: false
#| label: fig-FV
#| fig-cap: The Proportion of Obesity Against Consumption of the Required Amount of Fruit or Vegetables
#| out.width: "50%"

#| fig-pos: "H"


proportionsFV <- df |>
  group_by(FV, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(FV) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsFV, aes(x= FV, y= Proportion, fill = Obese))+
  geom_bar(stat = "identity", postition = "fill")+
  labs(title = "Proportion of Obesity by Fruit and Veg intake",
       x = "Fruit and Veg Intake (Yes/No)",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()
```

# Formal Analysis {#sec-FA}

We start by fitting the full regression model containing all explanatory variables. Since our response variable is binary, we fit a logistic regression model. The full model can be written as: MENTION WHY NOT DOING INTERACTION TERMS?

$$
Obese \sim Bernoulli(p_i)
$$

$$
logit(p_i)= \alpha + \beta_{\text{sex}}\cdot\mathbb{I}_{\text{sex}} + \beta_{\text{year}}\cdot\text{Year} + \beta_{\text{fv}}\cdot\mathbb{I}_{\text{FV}} + \beta_{\text{middle-aged}}\cdot\mathbb{I}_{\text{middle-aged}} + \beta_{\text{old}}\cdot\mathbb{I}_{\text{old}} + \beta_{retired}\cdot\mathbb{I}_{\text{retired}} + \beta_{unemployed}\cdot\mathbb{I}_{\text{unemployed}}
$$

where $p_i$ is the probability of being obese and

-   $\alpha$ is the intercept (the baseline log-odds of obesity when all predictors are at their reference category),

-   $\beta_\text{sex}$ is the coefficient for sex,

-   $\mathbb{I}_{\text{sex}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{sex}}(x) =
    \begin{cases}
    1 & \mbox{if gender of } x \mbox{ is male}, \\
    0 & \mbox{if gender of } x \mbox{ is female}.
    \end{cases}
$$

-   $\beta_\text{year}$ is the coefficient for survey year,

-   $\beta_\text{fv}$ is the coefficient for whether an individual consumes the daily intake of either fruit, vegetables or both,

-   $\mathbb{I}_{\text{FV}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{FV}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ consumes the recommended daily intake of fruit and/or vegetables}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{middle-aged}$ is the coefficient for being middle-aged (35-64 years old),

-   $\mathbb{I}_{\text{middle-aged}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{middle-aged}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is middle-aged (35-64 years old)}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{old}$ is the coefficient for being old (65+ years),

-   $\mathbb{I}_{\text{old}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{old}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is old (65+ years old)}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{retired}$ is the coefficient for being retired,

-   $\mathbb{I}_{\text{retired}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{retired}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is retired}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{unemployed}$ is the coefficient for being unemployed or in another non-working status,

-   $\mathbb{I}_{\text{unemployed}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{unemployed}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is unemployed or in another non-working status}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

```{r}
#| echo: false
mod2 <- glm(Obese ~ Sex + Year + FV + AgeCategory + Employment_Clean, data = df, family = binomial)
mod2_tidy <- mod2 %>% broom::tidy() %>% gt()
AIC_mod2 <- AIC(mod2)
```

PERHAPS SLIGHTLY REWORD AS I COPIED MAJORITY FROM THE EXAMPLE REPORT IN WEEK 6? Stepwise regression with backward selection will be used to determine whether the full model can be reduced based on the AIC. Hence, the model which results in the lowest AIC will result in the final model fitted to the data. In this case, the final model detailed below provides the lowest AIC. The regression coefficients from the model are displayed in @tbl-stepmod.

$$
logit(p_i)= \alpha + \beta_{\text{sex}}\cdot\mathbb{I}_{\text{sex}} + \beta_{\text{middle-aged}}\cdot\mathbb{I}_{\text{middle-aged}} + \beta_{\text{old}}\cdot\mathbb{I}_{\text{old}} + \beta_{retired}\cdot\mathbb{I}_{\text{retired}} + \beta_{unemployed}\cdot\mathbb{I}_{\text{unemployed}}
$$

```{r}
#| echo: false
step.model <- stepAIC(mod2, direction = "backward", trace = FALSE)
Coefs <- round(coef(step.model), 3)
AIC_stepmod <- step.model$anova[, 6]

step.model_tidy <- step.model %>% broom::tidy() %>% gt()
```

::: {layout-ncol="2"}
| Term               | Estimate  | p-value |
|--------------------|-----------|---------|
| Intercept          | -1.3402   | 0.0000  |
| Sex Male           | -0.1014   | 0.0069  |
| Middle-aged        | 0.5658    | 0.0000  |
| Old                | 0.6249    | 0.0000  |
| Retired            | 0.1036    | 0.1551  |
| Unemployed / Other | 0.4006    | 0.0000  |

: Estimates of the fitted model's coefficients to 4 d.p. {#tbl-stepmod}

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-cap: Odds (Obesity)
#| label: fig-odds
#| fig-align: center
#| out.width: "90%"
plot_model(step.model,
           show.values = TRUE,
           title = "", 
           show.p = FALSE, axis.lim = c(0.9, 1.95))
```
:::

INTERPRETING THE MODEL AND SEEING THIS VISUALLY IN @fig-odds @fig-odds tells us ..................... (FOCUS ON AGE AND EMPLOYMENT AS MOST SIGNIFICANT?)

CHECKING THE MODEL WITH AIC AND @fig-stepmoddiag AND @fig-stepmodroc.

```{r}
#| echo: false
#| fig-cap: GLM diagnostics for the obesity rates in Scotland
#| label: fig-stepmoddiag
#| fig-align: center
#| out.width: "50%"

library(performance)
check_model(step.model, panel = TRUE)

# IDK WHY IT IS SHOWING 5 PANELS INSTEAD OF 4???? IS IT POSSIBLE TO GET RID OF THE COLINEARITY MODEL OR IS THIS IMPORTANT? IF IMPORTANT ADD TO DESCRIPTION BELOW AS I HAVE IGNORED IT. E.g. given the large number of explanatory variables it is good pratice to test for colinearity... 
```

@fig-stepmoddiag allows us to assess if our model assumptions are met. The posterior predictive check shows that the model-predicted intervals include the observed data points. The binned residuals plot highlight that the majority of points fall within the error bounds however this does not appear to be 95% of the data..............??????????? The influential observations plot shows that all points are inside the contour lines. Finally, the uniformity of residuals plot displays that the observed values do not deviate from the model expectations when using simulated residuals. This therefore demonstrates that our model is appropriately fitted to the data.

MAYBE CUT AIC FOR FULL MODEL OR REWORD TO FOCUS ON THE REDUCED MODEL AND INTERPRETING THIS: The reduced model has an AIC of 17009.35 compared to the full model which has an AIC of 17011.99. This demonstrates that although the reduced model has a lower AIC, the difference is negligible.

::: {layout-ncol="2"}
```{r}
#| echo: false
#| fig-cap: ROC curve for Stepwise Regression Model
#| label: fig-stepmodroc
#| out.width: "90%"


pred_results <- step.model %>%
  augment(type.predict = c("response")) %>%
  mutate(predicted_class = factor(ifelse(.fitted > 0.5, "Yes", "No")))

roc_curve(pred_results,
          truth = Obese,
          .fitted,
          event_level = "second") %>%
  autoplot()

roc_value <- roc_auc(pred_results,
        truth = Obese,
        .fitted)
```

To assess how good the model is at separating if a person is obese or not, we will plot a ROC curve. This can be seen in @fig-stepmodroc. Since the ROC curve is fairly close to the diagonal line then this indicates that our model is only slighly better than random guessing. Ideally we would want to see the ROC curve closer to the top-left corner as this implies the model has high true positive rates and low false positive rates.
:::

Furthermore the ROC value is estimated at 0.432 which demonstrates............... we need to improve model??

EXPAND ABOVE????

# Conclusions {#sec-con}

REWRITE (CUT A BIT) AND MAKE SURE APPROPRIATE FOR THE CHANGES WE MADE IN THE FA SECTION.

This report has investigated trends in obesity prevalence in Scotland over time and examined the impact of socio-economic factors using logistic regression modeling. The findings indicate that obesity rates have remained relatively stable, with no significant change over the years, ALL ELSE CONSTANT? Furthermore, our model suggests that key socio-economic factors, such as age and employment status, play a crucial role in obesity prevalence. Specifically, being younger and being employed, all else constant, is associated with lower odds of obesity. In contrast, factors such as fruit and vegetable consumption had minimal impact. This highlights the impact of socio-economic conditions on health and the need ........

The model diagnostics confirm that our regression model is appropriately fitted to the data, with no major violations of model assumptions. However, the ROC curve suggests that the model’s predictive ability is only slightly better than random guessing, indicating that additional factors may be needed to better explain obesity prevalence.

CUT BELOW NOW ONLY DID STEPWISE? INSTEAD FOCUS ON THE ELIMINATION OF YEAR AND FV: We also attempted to refine the model using stepwise regression. While the reduced model achieved a marginally lower AIC, the difference was negligible, and its predictive performance remained similar to the full model. This suggests that while some variables could be excluded without significant loss of explanatory power, the overall findings remain consistent.

In conclusion, whilst obesity prevalence in Scotland has not changed significantly over time, socio-economic factors, particularly age and employment status, are important contributors. Future research could explore additional lifestyle, behavioral, and environmental factors to improve the predictive power of the model and gain deeper insights into obesity trends and interventions.
