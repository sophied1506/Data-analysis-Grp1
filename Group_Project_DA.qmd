---
title: "Has Scottish Obesity Prevalence Changed over the Years and do Different Factors Effect this"
author: "Jo Scott-Stephen, Eleanor Mills, Sophie Brown"
execute: 
  echo: false
  eval: true
  warning: false
number-sections: true
format:
  html:
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| warning: false
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidymodels)
library(sjPlot)
library(performance)
library(kableExtra)
library(gt)
```

```{r}
df<-read.csv("DAProject3.csv")
df$Sex<-as.factor(df$Sex)
df$AgeGroup<-as.factor(df$AgeGroup)
df$Veg<-as.factor(df$Veg)
df$Fruit<-as.factor(df$Fruit)
df$Obese<-as.factor(df$Obese)
df$Employment<-as.factor(df$Employment)

df$Employment_Clean<-as.factor(ifelse(df$Employment=="In full-time education"|df$Employment=="In paid employment, self-employed or on gov't training", "Employed/Full-Time Training or Education",ifelse(df$Employment=="Retired", "Retired", "Unemployed/Other")))

df$FV<-as.factor(ifelse(df$Fruit=="Yes"|df$Veg=="Yes", "Yes", "No"))

df$AgeCategory <- as.factor(ifelse(df$AgeGroup %in% c("16-24", "25-34"), "Young",
ifelse(df$AgeGroup %in% c("35-44", "45-54", "55-64"), "Middle-aged",
"Old")))
df$AgeCategory <- relevel(df$AgeCategory, ref = "Young")
```

# Introduction {#sec-intro}

Obesity rates have been observed to be increasing in many developed countries. However it has been linked to numerous health issues, specifically cardiovascular issues, diabetes and cancer. With data supplied by the Scottish Health Survey, we will be examining the trends in obesity of the Scottish population in the years 2013-2016, to see if Scotland is following that trend.

Furthermore, we will investigate whether any specific socio-economic characteristics and lifestyle factors indicate a higher probability of obesity, to see, more generally, if there is truly a correlation between the way we live and our health.

At first, we will investigate some exploratory data analysis ( @sec-EA ), before conducting our formal analysis (@sec-FA) and eventually reaching a cnclusion and a discussion ( @sec-con )

# Exploratory Analysis {#sec-EA}

We begin by conducting some exploratory data analysis to investigate whether obesity rates have changed over the years (@fig-obesityyear).

```{r}
#| label: fig-obesityyear
#| fig-cap: Proportion of obesity by Year
proportionsyear <- df |>
  group_by(Year, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Year) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsyear, aes(x = factor(Year), y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity (Yes/No) by Year",
       x = "Year",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()

```

@fig-obesityyear displays the proportion of Obesity by the each year the questionnaire has been taken. There appears to be very little if any difference in the change of obesity levels over the years.

We then investigate how different lifestyle factors and characteristics effect obesity.

```{r}
library(patchwork)

#| label: fig-ages
#| fig-cap: proportion of obesity by age categories

##graph 1
proportionsage <- df |>
  group_by(AgeGroup, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(AgeGroup) |>
  mutate(Proportion = Count/sum(Count))
  

p1 <- ggplot(proportionsage, aes(x = AgeGroup, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity (Yes/No) by Age",
       x = "Age",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()+
  guides(x= guide_axis(angle = 90))

##graph 2

proportionsagec <- df |>
  group_by(AgeCategory, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(AgeCategory) |>
  mutate(Proportion = Count/sum(Count))

p2 <- ggplot(proportionsagec, aes(x = AgeCategory, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity (Yes/No) by Age Category",
       x = "Age",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()
```

```{r}
#| label: fig-ages
#| fig-cap: Obesity proportions vs age groups (left) and age categories (right)

p1+p2
```

We look at @fig-ages to see if there is a significant relationship between obesity and age, i.e. can the age of a person change their likelihood of being obese.The bar plot on the left (@fig-age) does indicate an increase in obesity as age increases however it then drops in the last category (75+).

Due to these similar effects, we combine certain age groups based on widely societal definitions of young (16-34), middle-aged (35-64) and old (65+)

This refinement causes the difference in ages to be made clearer on the right (@fig-age), and we see that young people are less likely to be obese, middle aged are much more likely to be obese and elderly are the most likely to be obese.

Then we use @fig-gender to investigate the difference of obesity rates dependent on the gender of a person. The plot shows a slight difference in obesity levels across gender. There is a larger proportion of women who are obese, implying being female increases chances of obesity.

```{r}
#| label: fig-gender
#| fig-cap: proportion of obesity by gender

proportionsgender <- df |>
  group_by(Sex, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Sex) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsgender, aes(x = Sex, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity (Yes/No) by Sex",
       x = "Sex",
       y = "Proportion",
       fill = "Obesity") +
  theme_minimal()
```

We investigate the effect of socio-econommic status with @fig-social. This has been refined into three categories, 'employed/full time education', 'retired', 'unemployed/other'. We can see that the least amount of obesity occurs in the employed/full time education category, while the category with highest obesity rates is the unemployed/other category which is interesting when compared to the age graphs previously as we might have expected retired to have the highest rates as the older age catgories seemed to have higher obesity rates.

```{r}
#| label: fig-social
#| fig-cap: proportion of obesity by employment type


proportionssocial <- df |>
  group_by(Employment_Clean, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(Employment_Clean) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionssocial, aes(x = Employment_Clean, y = Proportion, fill = Obese)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Obesity (Yes/No) by Employment Type",
       x = "Employment Type",
       y = "Proportion",
       fill = "Obesity") +
  guides(x= guide_axis(angle = 45))
```

We then investigate some lifestyle, specifiaclly dietary influences (@fig-FV).

```{r}
#| label: fig-FV
#| fig-cap: The proportion of obesity vs if people consumed enough fruit or veg
proportionsFV <- df |>
  group_by(FV, Obese) |>
  summarise(Count = n(), .groups = "drop") |>
  group_by(FV) |>
  mutate(Proportion = Count/sum(Count))

ggplot(proportionsFV, aes(x= FV, y= Proportion, fill = Obese))+
  geom_bar(stat = "identity", postition = "fill")+
  labs(title = "Proportion of Obesity (Yes/No) by Fruit and Veg intake",
       x = "Fruit and Veg Intake (Yes/No)",
       y = "Proportion",
       fill = "Obesity")
```

@fig-FV displays a barplot of Obesity rates vs if surveyed people ate the correct amount of fruit and vegetables in a day (lifestyle factors). We might have expected this to show there is a significant impact on obesity rates if people ate their '5 a day' however there seems to be no difference in obesity depending on a persons fruit and veg intake.

# Formal Analysis {#sec-FA}

First we check if obesity prevalence has infact changed over the years in general, not taking any other variables into account. We do that by fitting the following logistic regression model

$$
\begin{align}
\mathrm{Obese}\sim Bernoulli(p_i)\\
\mathrm{logit}(p_i)=\alpha +  \beta_{\text{year}}\cdot\text{year}
\end{align}
$$

where $p_i$ is the probability of being obese

$\alpha$ is the intercept (the baseline log-odds of obesity when all predictors are at their reference category) and

$\beta_\text{year}$ is the coefficient for survey year

```{r}
#| label: tbl-summary1
#| tbl-cap: Results of fitting a logistic regression to see if obesity prevalence changes over the years
mod1 <- glm(Obese ~ Year, data = df, family = binomial)
x<-as.data.frame(broom::tidy(mod1))
x<-x[,c(1,2,5)]
gt(x)
```

As indicated from our previous plots (@fig-obesityyear), Obesity prevalence has seemed to stay rather constant over the years, with a small non-statistically significant increase of 0.0056 in the log-odds of obesity with every passing year.

We check the appropriateness of this model fit with the following plots (@fig-resid1).

```{r}
#| label: fig-resid1
#| fig-cap: Plots to check model appropriateness
library(performance)
check_model(mod1, panel = TRUE)
```

idk what to say, need to complete this when I have more time

Since there seems to be no significant change in the prevelance of obesity in Scotland over the years we will now investigate how socio-economic factors as well as other lifestyle factors affect obseity rates. We start by fitting the full multiple regression model containing all explanatory variables.

Since our response variable is binary, we fit a logistic regression model.

$$
Obese \sim Bernoulli(p_i)
$$

$$
logit(p_i)= \alpha + \beta_{\text{sex}}\cdot\mathbb{I}_{\text{sex}} + \beta_{\text{year}}\cdot\text{Year} + \beta_{\text{fv}}\cdot\mathbb{I}_{\text{FV}} + \beta_{\text{middle-aged}}\cdot\mathbb{I}_{\text{middle-aged}} + \beta_{\text{old}}\cdot\mathbb{I}_{\text{old}} + \beta_{retired}\cdot\mathbb{I}_{\text{retired}} + \beta_{unemployed}\cdot\mathbb{I}_{\text{unemployed}}
$$

We add new terms defined as follows:

-   $\beta_\text{sex}$ is the coefficient for sex,

-   $\mathbb{I}_{\text{sex}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{male}}(x) =
    \begin{cases}
    1 & \mbox{if gender of } x \mbox{ is male}, \\
    0 & \mbox{if gender of } x \mbox{ is female}.
    \end{cases}
$$

-   $\beta_\text{year}$ is the coefficient for survey year,

-   $\beta_\text{fv}$ is the coefficient for whether an individual consumes the daily intake of either fruit, vegetables or both,

-   $\mathbb{I}_{\text{FV}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{FV}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ consumes the recommended daily intake of fruit and/or vegetables}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{middle-aged}$ is the coefficient for being middle-aged (35-64 years old),

-   $\mathbb{I}_{\text{middle-aged}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{middle-aged}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is middle-aged (35-64 years old)}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{old}$ is the coefficient for being old (65+ years),

-   $\mathbb{I}_{\text{old}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{old}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is old (65+ years old)}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{retired}$ is the coefficient for being retired,

-   $\mathbb{I}_{\text{retired}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{retired}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is retired}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

-   $\beta_\text{unemployed}$ is the coefficient for being unemployed or in another non-working status,

-   $\mathbb{I}_{\text{unemployed}}(x)$ is an indicator function such that

$$
    \mathbb{I}_{\mbox{unemployed}}(x) =
    \begin{cases}
    1 & \mbox{if } x \mbox{ is unemployed or in another non-working status}, \\
    0 & \mbox{otherwise}.
    \end{cases}
$$

```{r}
#| echo: false
mod2 <- glm(Obese ~ Sex + FV + AgeCategory + Employment_Clean, data = df, family = binomial)
mod2_tidy <- mod2 %>% broom::tidy() %>% gt()
AIC_mod2 <- AIC(mod2)
```

| Term               | Estimate (to 3 d.p.) | p-value (to 4 d.p.) |
|--------------------|----------------------|---------------------|
| Intercept          | 1.723                | 0.0000              |
| Sex Male           | -0.104               | 0.0054              |
| FV yes             | -0.070               | 0.2422              |
| Middle-aged        | 0.570                | 0.0000              |
| Old                | 0.631                | 0.0000              |
| Retired            | 0.104                | 0.1528              |
| Unemployed / Other | 0.394                | 0.0000              |

: Estimates of the fitted model's coefficients. {#tbl-mod2}

@tbl-mod2 displays the fitted values from out model. From this we can see that both fruit and vegetables and retirement have large p-values, signifying these are not significant. 

However, most notably we can see that an increase in age with being classified as middle-aged causes an increased log-odds of 0.57 of being obese compared to young people and being classified as old causing an increased log-odds of being obese of 0.631 compared to young people.

Furthermore, we have a significant decrease in log-odds of being obese of 0.104 associated with being male instead of female, and a signifincant increase in the log-odds of obesity of 0.394 associated with being unemployed.

Agreeing with our previous plots that as you get older, you have a higher chance of being obese (@fig-age), and being female increases your odds of being obese (@fig-gender) and that if you are not retired or in the labour market you are more likely to be obese (@fig-employ).

```{r}
#| echo: false
#| fig-cap: GLM diagnostics for the obesity rates in Scotland
#| label: fig-mod2diag
#| fig-align: center

library(performance)
check_model(mod2, panel = TRUE)
# IDK WHY IT IS SHOWING 5 PANELS INSTEAD OF 4????
```

@fig-mod2diag allows us to assess if our model assumptions are met. The posterior predictive check shows that the model-predicted intervals include the observed data points. The binned residuals plot highlight that the majority of points fall within the error bounds. The influential observations plot shows that all points are inside the contour lines. Finally, the uniformity of residuals plot displays that the observed values do not deviate from the model expectations when using simulated residuals. This therefore demonstrates that our model is appropriately fitted to the data.

```{r}
#| echo: false
#| fig-cap: ROC curve for full socioeconomic model
#| label: fig-mod2roc
#| fig-align: center
pred_results <- mod2 %>%
  augment(type.predict = c("response")) %>%
  mutate(predicted_class = factor(ifelse(.fitted > 0.5, "Yes", "No")))

roc_curve(pred_results,
          truth = Obese,
          .fitted,
          event_level = "second") %>%
  autoplot()
```

To assess how good the model is at separating if a person is obese or not, we will plot a ROC curve. This can be seen in @fig-mod2roc. Since the ROC curve is fairly close to the diagonal line then this indicates that our model is only slighly better than random guessing. Ideally we would want to see the ROC curve closer to the top-left corner as this implies the model has high true positive rates and low false positive rates.

##Conclusion

The model diagnostics confirm that our regression model is appropriately fitted to the data, with no major violations of model assumptions. However, the ROC curve suggests that the model's predictive ability is only slightly better than random guessing, indicating that additional factors may be needed to better explain obesity prevalence.

We also attempted to refine the model using stepwise regression. While the reduced model achieved a marginally lower AIC, the difference was negligible, and its predictive performance remained similar to the full model. This suggests that while some variables could be excluded without significant loss of explanatory power, the overall findings remain consistent.

In conclusion, whilst obesity prevalence in Scotland has not changed significantly over time, socio-economic factors, particularly age and employment status, are important contributors. Future research could explore additional lifestyle, behavioral, and environmental factors to improve the predictive power of the model and gain deeper insights into obesity trends and interventions.
